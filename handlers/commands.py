"""
User command handlers.
"""

from core.telegram import bot, app_logger
from core.openai_client import client
from auth.access_control import is_authorized
from models.model_manager import fetch_models
from storage.user_settings import get_user_model, set_user_model
from storage.chat_history import clear_chat_history
from utils.decorators import require_auth, rate_limited, log_command, handle_errors
from config.help_texts import HELP_TEXTS


@bot.message_handler(commands=["help", "start"])
@require_auth()
def send_welcome(message):
    # –î–ª—è –∞–¥–º–∏–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é —Å–ø—Ä–∞–≤–∫—É
    from auth.access_control import is_admin

    help_text = HELP_TEXTS["admin"] if is_admin(message) else HELP_TEXTS["user"]
    bot.reply_to(message, help_text, parse_mode="Markdown")


@bot.message_handler(commands=["new"])
@require_auth()
@log_command
@handle_errors("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
def clear_history(message):
    success = clear_chat_history(message.chat.id)
    if success:
        bot.reply_to(message, "‚úÖ –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –æ—á–∏—â–µ–Ω–∞!")
    else:
        raise Exception("Failed to clear chat history")


@bot.message_handler(commands=["models"])
@require_auth()
@log_command
@handle_errors()
def list_models(message):
    current_model = get_user_model(message.chat.id)
    models_by_owner = fetch_models()

    models_list = "üìã *–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏:*\n\n"

    for owner, models in sorted(models_by_owner.items()):
        models_list += f"üè¢ *{owner}*\n"
        for model_id in sorted(models):
            prefix = "‚ñ∂Ô∏è " if model_id == current_model else "  "
            models_list += f"{prefix}`{model_id}`\n"
        models_list += "\n"

    models_list += f"üîß –¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å: `{current_model}`"
    models_list += "\n\n–ò—Å–ø–æ–ª—å–∑—É–π /model <–Ω–∞–∑–≤–∞–Ω–∏–µ> –¥–ª—è —Å–º–µ–Ω—ã –º–æ–¥–µ–ª–∏"

    bot.reply_to(message, models_list, parse_mode="Markdown")


@bot.message_handler(commands=["model"])
@require_auth()
@log_command
@handle_errors()
def set_model(message):
    args = message.text.split("/model")[1].strip()
    if len(args) == 0:
        bot.reply_to(
            message,
            "–ò—Å–ø–æ–ª—å–∑—É–π: /model <–Ω–∞–∑–≤–∞–Ω–∏–µ>\n\n–°–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π: /models",
            parse_mode="Markdown",
        )
        return

    model_name = args.strip()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –º–æ–¥–µ–ª—å
    models_by_owner = fetch_models()
    all_models = []
    for models in models_by_owner.values():
        all_models.extend(models)

    if model_name not in all_models:
        bot.reply_to(
            message,
            f"‚ùå –ú–æ–¥–µ–ª—å `{model_name}` –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.\n\n–°–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π: /models",
            parse_mode="Markdown",
        )
        return

    set_user_model(message.chat.id, model_name)
    bot.reply_to(
        message,
        f"‚úÖ –ú–æ–¥–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: `{model_name}`",
        parse_mode="Markdown",
    )


@bot.message_handler(commands=["image"])
@require_auth()
@rate_limited
@log_command
@handle_errors("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ!")
def image(message):
    prompt = message.text.split("/image")[1].strip()
    if len(prompt) == 0:
        bot.reply_to(message, "–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã /image")
        return

    response = client.images.generate(
        prompt=prompt, n=1, size="1024x1024", model="dall-e-3"
    )
    image_url = response.data[0].url

    bot.send_photo(
        message.chat.id,
        image_url,
        reply_to_message_id=message.message_id,
    )
