# AGENT.md - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è AI –∞–≥–µ–Ω—Ç–æ–≤

## –û –ø—Ä–æ–µ–∫—Ç–µ

**Telegram AI Chat Bot** ‚Äî production-ready Telegram –±–æ—Ç —Å –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–º–∏ AI –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

### –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üí¨ **–ú—É–ª—å—Ç–∏–º–æ–¥–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —á–∞—Ç** ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ GLM, GPT, Qwen –∏ –¥—Ä—É–≥–∏—Ö OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö –º–æ–¥–µ–ª–µ–π
- üëÅÔ∏è **–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** ‚Äî GPT-4 Vision –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- üé® **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è DALL-E 3
- üé§ **–ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è** ‚Äî Whisper —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è + TTS –æ—Ç–≤–µ—Ç—ã
- üîß **MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã** ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤–Ω–µ—à–Ω–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (—Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞, –≤–µ–±-–ø–æ–∏—Å–∫, GitHub, –ë–î)
- üíæ **S3 —Ö—Ä–∞–Ω–∏–ª–∏—â–µ** ‚Äî –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- üîê **–°–∏—Å—Ç–µ–º–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º** ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Å—Ç–∞—Ç—É—Å–∞–º–∏ pending/approved/denied
- ‚ö° **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚Äî –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π, –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ, –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –≤—Ä–µ–º–µ–Ω–∏
- üèóÔ∏è **–ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** ‚Äî 19 –º–æ–¥—É–ª–µ–π –≤ 7 –ø–∞–∫–µ—Ç–∞—Ö

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π

```
aichatbot/
‚îú‚îÄ‚îÄ bot.py                    # Entry point (86 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ config/                   # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py          # Env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ help_texts.py        # –¢–µ–∫—Å—Ç—ã –ø–æ–º–æ—â–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥
‚îú‚îÄ‚îÄ core/                     # –ë–∞–∑–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ telegram.py          # Bot instance –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ openai_client.py     # OpenAI client
‚îÇ   ‚îî‚îÄ‚îÄ async_helpers.py     # –ì–ª–æ–±–∞–ª—å–Ω—ã–π event loop –¥–ª—è async –æ–ø–µ—Ä–∞—Ü–∏–π
‚îú‚îÄ‚îÄ handlers/                 # Telegram –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ commands.py          # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã
‚îÇ   ‚îú‚îÄ‚îÄ admin_commands.py    # –ê–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã
‚îÇ   ‚îú‚îÄ‚îÄ mcp_commands.py      # MCP —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ messages.py          # –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ voice.py             # –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
‚îú‚îÄ‚îÄ auth/                     # –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞
‚îÇ   ‚îú‚îÄ‚îÄ validators.py        # –í–∞–ª–∏–¥–∞—Ü–∏—è username
‚îÇ   ‚îú‚îÄ‚îÄ user_manager.py      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
‚îÇ   ‚îî‚îÄ‚îÄ access_control.py    # –ü—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ ai/                       # AI –æ–±—Ä–∞–±–æ—Ç–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ processor.py         # –û—Å–Ω–æ–≤–Ω–∞—è AI –ª–æ–≥–∏–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ tool_executor.py     # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
‚îú‚îÄ‚îÄ storage/                  # S3 –æ–ø–µ—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ base.py              # –ë–∞–∑–æ–≤—ã–µ S3 –æ–ø–µ—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ s3_client.py         # S3 client initialization
‚îÇ   ‚îú‚îÄ‚îÄ chat_history.py      # –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞
‚îÇ   ‚îî‚îÄ‚îÄ user_settings.py     # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îú‚îÄ‚îÄ models/                   # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—è–º–∏
‚îÇ   ‚îî‚îÄ‚îÄ model_manager.py     # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π
‚îú‚îÄ‚îÄ utils/                    # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ formatters.py        # Markdown ‚Üí HTML –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ messaging.py         # –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ rate_limiter.py      # Rate limiting (10 req/min)
‚îÇ   ‚îú‚îÄ‚îÄ typing_indicator.py  # Typing action
‚îÇ   ‚îî‚îÄ‚îÄ decorators.py        # –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã
‚îú‚îÄ‚îÄ mcp_manager.py            # MCP –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
‚îú‚îÄ‚îÄ docs/                     # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ ARCHITECTURE.md      # –î–µ—Ç–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ MCP_SETUP.md         # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MCP
‚îÇ   ‚îú‚îÄ‚îÄ MINIO_SETUP.md       # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ S3 —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
‚îÇ   ‚îî‚îÄ‚îÄ PERFORMANCE.md       # –î–µ—Ç–∞–ª–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
‚îú‚îÄ‚îÄ .env.example              # –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ mcp.json.example          # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ MCP
‚îú‚îÄ‚îÄ requirements.txt          # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ Dockerfile                # Docker –æ–±—Ä–∞–∑
‚îî‚îÄ‚îÄ docker-compose.yml        # Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```
User ‚Üí Telegram API ‚Üí handlers/ ‚Üí auth/ ‚Üí ai/processor.py
                                            ‚Üì
                                       OpenAI API
                                            ‚Üì
                                  MCP Tools (pooled connections)
                                            ‚Üì
                                       S3 Storage
```

## –ö–ª—é—á–µ–≤—ã–µ –º–æ–¥—É–ª–∏

### 1. Entry Point: `bot.py`

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MCP manager (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω)
- –ò–º–ø–æ—Ä—Ç handlers (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã)
- Warmup –∫–µ—à–∞ MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
- Graceful shutdown —Å –∑–∞–∫—Ä—ã—Ç–∏–µ–º –≤—Å–µ—Ö MCP —Å–µ—Å—Å–∏–π
- –ó–∞–ø—É—Å–∫ polling

**–í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏:**
```python
# –ì–ª–æ–±–∞–ª—å–Ω—ã–π singleton –¥–ª—è MCP
ai.processor.mcp_manager = MCPServerManager(configs)

# –ü—Ä–æ–≥—Ä–µ–≤ –∫–µ—à–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
if MCP_WARMUP_CACHE:
    tools = run_async(mcp_manager.get_all_tools())

# Graceful shutdown
signal.signal(signal.SIGINT, shutdown_handler)
signal.signal(signal.SIGTERM, shutdown_handler)
```

### 2. Configuration: `config/__init__.py`

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
- `TG_BOT_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω Telegram –±–æ—Ç–∞
- `ADMIN_USERNAME`, `ADMIN_CHAT_ID` ‚Äî –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
- `OPENAI_API_KEY`, `OPENAI_BASE_URL` ‚Äî OpenAI API
- `S3_KEY_ID`, `S3_KEY_SECRET`, `S3_BUCKET` ‚Äî S3 —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- `MAX_HISTORY_LENGTH` ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∏—Å—Ç–æ—Ä–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 50)
- `MCP_CACHE_TTL_SECONDS` ‚Äî TTL –∫–µ—à–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3600)

**–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã:**
```python
RATE_LIMIT_REQUESTS = 10  # –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
RATE_LIMIT_WINDOW = 60    # –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
MCP_TOOL_TIMEOUT_SECONDS = 60
MCP_MAX_ITERATIONS = 5    # –º–∞–∫—Å –∏—Ç–µ—Ä–∞—Ü–∏–π tool calling
MAX_VISION_TOKENS = 4000
```

### 3. MCP Manager: `mcp_manager.py`

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

**Connection Pooling:**
- –ê–∫—Ç–∏–≤–Ω—ã–µ MCP —Å–µ—Å—Å–∏–∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 1 —á–∞—Å–∞ (TTL)
- ~100ms —ç–∫–æ–Ω–æ–º–∏–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∏ shutdown

**Tools Caching:**
- –°–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∫–µ—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 1 —á–∞—Å (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- ~6 —Å–µ–∫—É–Ω–¥ —ç–∫–æ–Ω–æ–º–∏–∏ –Ω–∞ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

**–ú–µ—Ç–æ–¥—ã:**
```python
async def get_all_tools() -> List[Dict]
    # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ OpenAI
    # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–µ—à, –µ—Å–ª–∏ –≤–∞–ª–∏–¥–µ–Ω

async def execute_tool(tool_name: str, arguments: Dict) -> Any
    # –ù–∞—Ö–æ–¥–∏—Ç —Å–µ—Ä–≤–µ—Ä —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç
    # –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Å—Å–∏–∏

async def _get_or_create_session(config: MCPServerConfig)
    # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Å—Å–∏—é –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é
    # –ö–ª—é—á–µ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è connection pooling

async def close_all_sessions()
    # –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ shutdown)
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–µ—à–∞:**
```python
self._tool_cache = {}           # {tool_name: server_name}
self._tools_list_cache = []     # OpenAI-formatted tools
self._active_sessions = {}      # {server_name: session_data}
```

### 4. AI Processor: `ai/processor.py`

**–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:**
```python
def process_text_message(text, chat_id, image_content=None):
    """
    1. –ü–æ–ª—É—á–∏—Ç—å –º–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    2. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑ S3
    3. –û–±—Ä–µ–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–æ MAX_HISTORY_LENGTH
    4. –î–æ–±–∞–≤–∏—Ç—å system message –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–æ–≤
    5. –ü–æ–ª—É—á–∏—Ç—å MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã)
    6. –í—ã–∑–≤–∞—Ç—å OpenAI API
    7. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å tool calls (–¥–æ MCP_MAX_ITERATIONS)
    8. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤ S3
    9. –í–µ—Ä–Ω—É—Ç—å –æ—Ç–≤–µ—Ç
    """
```

**Tool Calling Flow:**
```python
# 1. –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ API —Å tools
chat_completion = client.chat.completions.create(
    model=model,
    messages=history,
    tools=tools_param,
    tool_choice="auto"
)

# 2. –ï—Å–ª–∏ –µ—Å—Ç—å tool_calls ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å —á–µ—Ä–µ–∑ ToolExecutor
if chat_completion.choices[0].message.tool_calls:
    executor = ToolExecutor(mcp_manager, history, model, tools_param)
    final_response = executor.execute_tool_calls(
        chat_completion.choices[0].message.tool_calls
    )
```

**Error Handling:**
- `BadRequestError` (–∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω) ‚Üí –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏ retry
- MCP –æ—à–∏–±–∫–∏ ‚Üí graceful degradation (–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)
- HTML parse errors ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∫ plain text

### 5. Storage Layer: `storage/`

**S3 —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
s3://bucket/
  ‚îú‚îÄ‚îÄ {chat_id}.json              # –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞
  ‚îú‚îÄ‚îÄ {chat_id}_settings.json     # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (model, mcp_enabled)
  ‚îî‚îÄ‚îÄ {ADMIN_CHAT_ID}_users.json  # –ë–∞–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
```python
# chat_history.py
get_chat_history(chat_id) -> List[Dict]
save_chat_history(chat_id, history)
clear_chat_history(chat_id)

# user_settings.py
get_user_model(chat_id) -> str
set_user_model(chat_id, model)
should_use_mcp_for_user(chat_id) -> bool
set_mcp_for_user(chat_id, enabled)
```

### 6. Auth Layer: `auth/`

**–¢—Ä–µ—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞:**
1. **Admin** ‚Äî –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø, –æ–¥–æ–±—Ä—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. **Approved** ‚Äî –æ–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –¥–æ—Å—Ç—É–ø–æ–º
3. **Pending/Denied** ‚Äî –æ–∂–∏–¥–∞—é—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω—ã

**–§—É–Ω–∫—Ü–∏–∏:**
```python
# access_control.py
is_authorized(message) -> bool
is_admin(message) -> bool

# user_manager.py
register_user(username, chat_id)  # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –∞–¥–º–∏–Ω–∞
get_user_status(username) -> str
set_user_status(username, status)
```

## –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è

### 1. Decorator Pattern –¥–ª—è Handlers

–í—Å–µ handlers –∏—Å–ø–æ–ª—å–∑—É—é—Ç –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:

```python
from core.telegram import bot

@bot.message_handler(commands=['start', 'help'])
def handle_start(message):
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã
    pass
```

**–ò–º–ø–æ—Ä—Ç –≤ `bot.py`:**
```python
import handlers  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤—Å–µ handlers
```

### 2. Async/Sync Bridge

MCP –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ, –Ω–æ Telegram handlers —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ:

```python
from core.async_helpers import run_async

# –í —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–¥–µ
tools = run_async(mcp_manager.get_all_tools())
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
# core/async_helpers.py
_event_loop = None  # –ì–ª–æ–±–∞–ª—å–Ω—ã–π event loop

def run_async(coro):
    """–ó–∞–ø—É—Å—Ç–∏—Ç—å async —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ sync –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"""
    global _event_loop
    if _event_loop is None:
        _event_loop = asyncio.new_event_loop()
    return _event_loop.run_until_complete(coro)
```

### 3. Singleton Pattern

```python
# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ instances
from core.telegram import bot, app_logger
from core.openai_client import client
import ai.processor  # mcp_manager —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ bot.py
```

### 4. Repository Pattern

`storage/` –º–æ–¥—É–ª–∏ –¥–µ–π—Å—Ç–≤—É—é—Ç –∫–∞–∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:

```python
# –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è –Ω–∞–¥ S3 –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
get_chat_history(chat_id)  # –°–∫—Ä—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ S3
save_chat_history(chat_id, history)
```

### 5. Graceful Degradation

```python
# MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
try:
    tools_param = run_async(mcp_manager.get_all_tools())
except Exception as e:
    app_logger.error(f"MCP failed: {e}")
    tools_param = None  # –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
```

## MCP Integration

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (mcp.json)

**–í—Å–µ MCP —Å–µ—Ä–≤–µ—Ä—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ `mcp.json`** (–Ω–µ –≤ `.env`):

```json
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-filesystem", "/app/mcp_workspace"],
      "enabled": true,
      "description": "–†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏"
    },
    "brave-search": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-brave-search"],
      "env": {"BRAVE_API_KEY": "your_key"},
      "enabled": true
    }
  }
}
```

### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Å–µ—Å—Å–∏–∏

1. **–ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞**: —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é, –≤—ã–ø–æ–ª–Ω–∏—Ç—å, –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞—Ç—å
2. **–ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã** (< 1 —á–∞—Å): –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–µ—Å—Å–∏—é
3. **–ü–æ—Å–ª–µ 1 —á–∞—Å–∞ idle**: —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–∞–µ—Ç, —Å–ª–µ–¥—É—é—â–∏–π –≤—ã–∑–æ–≤ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—É—é
4. **–ü—Ä–∏ –æ—à–∏–±–∫–µ**: –∑–∞–∫—Ä—ã—Ç—å —Å–µ—Å—Å–∏—é, –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–µ—à, —Å–ª–µ–¥—É—é—â–∏–π –≤—ã–∑–æ–≤ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—É—é
5. **–ü—Ä–∏ shutdown**: –∑–∞–∫—Ä—ã—Ç—å –≤—Å–µ —Å–µ—Å—Å–∏–∏ gracefully

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ MCP —Å–µ—Ä–≤–µ—Ä–∞

1. –û—Ç–∫—Ä—ã—Ç—å `mcp.json`
2. –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é —Å–µ—Ä–≤–µ—Ä–∞
3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `enabled: true`
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞

```json
{
  "mcpServers": {
    "new-server": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-name"],
      "env": {"API_KEY": "your_key"},
      "enabled": true,
      "description": "–û–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞"
    }
  }
}
```

## Best Practices –¥–ª—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–π

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã

**–°–æ–∑–¥–∞—Ç—å –≤ `handlers/commands.py` –∏–ª–∏ –Ω–æ–≤–æ–º —Ñ–∞–π–ª–µ:**

```python
from core.telegram import bot
from auth.access_control import is_authorized

@bot.message_handler(commands=['mycommand'])
def handle_mycommand(message):
    if not is_authorized(message):
        return

    # –í–∞—à–∞ –ª–æ–≥–∏–∫–∞
    bot.reply_to(message, "–û—Ç–≤–µ—Ç")
```

**Handler –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ `handlers`**

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π storage —Ñ—É–Ω–∫—Ü–∏–∏

**–í `storage/user_settings.py` –∏–ª–∏ –Ω–æ–≤–æ–º —Ñ–∞–π–ª–µ:**

```python
from storage.base import s3_get_object, s3_put_object

def get_user_preference(chat_id, key):
    """–ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    settings = s3_get_object(f"{chat_id}_settings.json")
    return settings.get(key)

def set_user_preference(chat_id, key, value):
    """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    settings = s3_get_object(f"{chat_id}_settings.json")
    settings[key] = value
    s3_put_object(f"{chat_id}_settings.json", settings)
```

### 3. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ AI processor

**–î–ª—è –Ω–æ–≤–æ–π AI —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:**

```python
# ai/processor.py –∏–ª–∏ –Ω–æ–≤—ã–π —Ñ–∞–π–ª ai/my_feature.py

def process_special_request(text, chat_id):
    """–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞"""
    model = get_user_model(chat_id)

    # –í–∞—à–∞ –ª–æ–≥–∏–∫–∞
    response = client.chat.completions.create(
        model=model,
        messages=[{"role": "user", "content": text}]
    )

    return response.choices[0].message.content
```

### 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —É—Ç–∏–ª–∏—Ç—ã

**–í `utils/` –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:**

```python
# utils/my_utils.py

def my_helper_function(input):
    """–û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏"""
    # –õ–æ–≥–∏–∫–∞
    return result
```

### 5. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞

**–û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞:**
- **Single Responsibility** ‚Äî –∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–¥–Ω—É –æ–±–ª–∞—Å—Ç—å
- **DRY** ‚Äî –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥, —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- **Error Handling** ‚Äî –≤—Å–µ–≥–¥–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Å graceful degradation
- **Logging** ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `app_logger` –¥–ª—è –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
- **Timing Logs** ‚Äî –¥–æ–±–∞–≤–ª—è—Ç—å –ª–æ–≥–∏ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**–ü—Ä–∏–º–µ—Ä –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏:**

```python
# –ü–õ–û–•–û: –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
def func1():
    data = s3.get_object(...)
    # –æ–±—Ä–∞–±–æ—Ç–∫–∞

def func2():
    data = s3.get_object(...)
    # –æ–±—Ä–∞–±–æ—Ç–∫–∞

# –•–û–†–û–®–û: –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
def get_data_from_s3(key):
    return s3.get_object(key)

def func1():
    data = get_data_from_s3(key)
    # –æ–±—Ä–∞–±–æ—Ç–∫–∞

def func2():
    data = get_data_from_s3(key)
    # –æ–±—Ä–∞–±–æ—Ç–∫–∞
```

## –¢–∏–ø–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –º–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

**–§–∞–π–ª—ã:**
- `models/model_manager.py` ‚Äî —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

```python
DEFAULT_MODELS = [
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
    {"id": "new-model", "owned_by": "provider"},
]
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ò–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç –∏—Å—Ç–æ—Ä–∏–∏

**–§–∞–π–ª—ã:**
- `.env` ‚Äî `MAX_HISTORY_LENGTH=50`
- `config/__init__.py` ‚Äî —á–∏—Ç–∞–µ—Ç –∏–∑ env

```bash
# .env
MAX_HISTORY_LENGTH=100  # –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 100
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç

**–§–∞–π–ª—ã:**
- `mcp.json` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞

```json
{
  "mcpServers": {
    "my-tool": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-my-tool"],
      "enabled": true
    }
  }
}
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ò–∑–º–µ–Ω–∏—Ç—å rate limit

**–§–∞–π–ª—ã:**
- `config/__init__.py` ‚Äî –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã rate limit

```python
RATE_LIMIT_REQUESTS = 20  # –ë—ã–ª–æ 10
RATE_LIMIT_WINDOW = 60    # —Å–µ–∫—É–Ω–¥
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–§–∞–π–ª—ã:**
- `auth/user_manager.py` ‚Äî –ª–æ–≥–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
- `handlers/admin_commands.py` ‚Äî –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞

```python
# –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å "premium"
VALID_STATUSES = ["pending", "approved", "denied", "premium"]
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 6: –ò–∑–º–µ–Ω–∏—Ç—å TTL –∫–µ—à–∞ MCP

**–§–∞–π–ª—ã:**
- `.env` ‚Äî `MCP_CACHE_TTL_SECONDS=3600`
- `mcp_manager.py` ‚Äî `self._session_ttl = 3600` (hardcoded)

```bash
# .env
MCP_CACHE_TTL_SECONDS=7200  # 2 —á–∞—Å–∞

# mcp_manager.py (–¥–ª—è session TTL)
self._session_ttl = 7200  # 2 —á–∞—Å–∞
```

## Performance Optimizations

### 1. MCP Tools Caching

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MCP —Å–µ—Ä–≤–µ—Ä–∞–º –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å (~6 —Å–µ–∫—É–Ω–¥)

**–†–µ—à–µ–Ω–∏–µ:**
- –°–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∫–µ—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 1 —á–∞—Å (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ~6 —Å–µ–∫—É–Ω–¥ —ç–∫–æ–Ω–æ–º–∏–∏ –Ω–∞ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

### 2. MCP Connection Pooling

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (~100ms –æ–≤–µ—Ä—Ö–µ–¥)

**–†–µ—à–µ–Ω–∏–µ:**
- –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 1 —á–∞—Å–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ~100ms —ç–∫–æ–Ω–æ–º–∏–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ

### 3. API Request Timing Logs

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ API

**–†–µ—à–µ–Ω–∏–µ:**
- –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –≤—Å–µ—Ö API –≤—ã–∑–æ–≤–æ–≤
- –õ–æ–≥–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```log
API request started: chat_id=123, model=glm-4.7, messages=5, tools=4
API response received: chat_id=123, model=glm-4.7, duration=27.01s
Reusing existing session for brave-search
Tool executed: brave_web_search, duration=1.54s
```

### –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–¢–∏–ø–∏—á–Ω—ã–π breakdown –∑–∞–ø—Ä–æ—Å–∞:**
```
Total Time: 68.20s
‚îú‚îÄ‚îÄ API Calls: 65.16s (95.5%)
‚îÇ   ‚îú‚îÄ‚îÄ Initial: 27.01s (39.6%)
‚îÇ   ‚îú‚îÄ‚îÄ Iteration 1: 1.74s (2.6%)
‚îÇ   ‚îî‚îÄ‚îÄ Final: 36.41s (53.4%)
‚îî‚îÄ‚îÄ MCP Tools: 3.04s (4.5%)
    ‚îú‚îÄ‚îÄ Tool 1: 1.54s (2.3%)
    ‚îî‚îÄ‚îÄ Tool 2: 1.50s (2.2%)
```

**–í—ã–≤–æ–¥:** API latency ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–µ —É–∑–∫–æ–µ –º–µ—Å—Ç–æ (90%+ –≤—Ä–µ–º–µ–Ω–∏), –Ω–µ MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

## Troubleshooting

### Connection Pooling –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–°–∏–º–ø—Ç–æ–º—ã:**
- –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "Connecting to..." –Ω–∞ –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
- –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π "Reusing existing session"

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. Session TTL –∏—Å—Ç–µ–∫
2. –û—à–∏–±–∫–∏ –≤—ã–∑—ã–≤–∞—é—Ç –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é —Å–µ—Å—Å–∏–∏
3. –†–∞–∑–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `_active_sessions` –∑–∞–ø–æ–ª–Ω–µ–Ω
- –£–≤–µ–ª–∏—á–∏—Ç—å `_session_ttl` –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### Tools Cache –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–°–∏–º–ø—Ç–æ–º—ã:**
- –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "Fetching fresh tools from all servers" –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å
- –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π "Using cached tools"

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. Cache TTL —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π
2. Cache timestamp –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
3. `MCP_CACHE_TTL_SECONDS` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ `MCP_CACHE_TTL_SECONDS`
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `_cache_timestamp` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- –ò—Å–∫–∞—Ç—å –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é –∫–µ—à–∞ –≤ –ª–æ–≥–∞—Ö

### –ú–µ–¥–ª–µ–Ω–Ω—ã–µ API –∑–∞–ø—Ä–æ—Å—ã

**–°–∏–º–ø—Ç–æ–º—ã:**
- API –≤—ã–∑–æ–≤—ã –∑–∞–Ω–∏–º–∞—é—Ç >30s
- –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –≤—ã—Å–æ–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è `duration`

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. API endpoint –º–µ–¥–ª–µ–Ω–Ω—ã–π
2. –ë–æ–ª—å—à–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π)
3. –°–ª–æ–∂–Ω—ã–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ API endpoint
- –£–º–µ–Ω—å—à–∏—Ç—å `MAX_HISTORY_LENGTH` –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –£–ø—Ä–æ—Å—Ç–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
- –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 1. –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è MCP

**–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:**
```bash
# .env
MCP_FILESYSTEM_ENABLED=true  # DEPRECATED
```

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
```json
// mcp.json
{
  "mcpServers": {
    "filesystem": {
      "enabled": true
    }
  }
}
```

### 2. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å graceful degradation

```python
# MCP –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
try:
    tools = run_async(mcp_manager.get_all_tools())
except Exception:
    tools = None  # –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
```

### 3. –û–±—Ä–µ–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è

```python
if len(history) > MAX_HISTORY_LENGTH:
    history = history[-MAX_HISTORY_LENGTH:]
```

### 4. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤–∞–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

```python
app_logger.info(f"Operation: chat_id={chat_id}, param={value}")
app_logger.error(f"Error: {e}")
```

### 5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å timing logs –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```python
import time
start_time = time.time()
# –û–ø–µ—Ä–∞—Ü–∏—è
duration = time.time() - start_time
app_logger.info(f"Operation completed: duration={duration:.2f}s")
```

### 6. –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é

```python
from auth.access_control import is_authorized

@bot.message_handler(commands=['command'])
def handle_command(message):
    if not is_authorized(message):
        return  # –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
    # –õ–æ–≥–∏–∫–∞
```

### 7. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å context managers –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤

```python
# –ü–õ–û–•–û
file = open('file.txt')
data = file.read()
file.close()

# –•–û–†–û–®–û
with open('file.txt') as file:
    data = file.read()
```

### 8. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ

```python
# –ü–õ–û–•–û
try:
    operation()
except Exception:
    pass

# –•–û–†–û–®–û
try:
    operation()
except SpecificError as e:
    app_logger.error(f"Specific error: {e}")
    # Fallback –¥–µ–π—Å—Ç–≤–∏–µ
except AnotherError as e:
    app_logger.error(f"Another error: {e}")
    # –î—Ä—É–≥–æ–µ fallback –¥–µ–π—Å—Ç–≤–∏–µ
```

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- **ARCHITECTURE.md** ‚Äî –¥–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- **MCP_SETUP.md** ‚Äî —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ MCP
- **MINIO_SETUP.md** ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è S3 —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
- **PERFORMANCE.md** ‚Äî –¥–µ—Ç–∞–ª–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –∏ –±–µ–Ω—á–º–∞—Ä–∫–∏
- **README.md** ‚Äî –æ–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ –∏ quick start

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏

- [ ] –°–ª–µ–¥–æ–≤–∞—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø—É Single Responsibility
- [ ] –ù–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ (DRY)
- [ ] –î–æ–±–∞–≤–∏—Ç—å error handling —Å graceful degradation
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤–∞–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] –î–æ–±–∞–≤–∏—Ç—å timing logs –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–µ –Ω–∞—Ä—É—à–µ–Ω—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–æ–≤—ã–π –∫–æ–¥ —Å–ª–µ–¥—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –ø—Ä–æ–µ–∫—Ç–∞

---

**–ê–≤—Ç–æ—Ä:** –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã –ø—Ä–æ–µ–∫—Ç–∞
**–î–∞—Ç–∞:** 2026-02-07
**–í–µ—Ä—Å–∏—è:** 1.0
